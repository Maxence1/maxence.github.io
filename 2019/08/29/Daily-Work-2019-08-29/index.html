<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <!--Description-->
  
  <meta name="description" content="This is a blog with my daily thinks.">
  

  <!--Author-->
  
  <meta name="author" content="Pengda Feng">
  

  <!--Open Graph Title-->
  
      <meta property="og:title" content="Daily Work 2019-08-29">
  
  <!--Open Graph Description-->
  
      <meta property="og:description" content="This is a blog with my daily thinks.">
  
  <!--Open Graph Site Name-->
  <meta property="og:site_name" content="The IT Crowd">
  <!--Type page-->
  
      <meta property="og:type" content="article">
  
  <!--Page Cover-->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <!-- Title -->
  
  <title>Daily Work 2019-08-29 - The IT Crowd</title>


  <link rel="shortcut icon" href="https://hexo.io/icon/favicon-96x96.png">

  <!-- Custom CSS/Sass -->
  <link rel="stylesheet" href="/css/style.css">

  <!----------------------------
  https://github.com/GallenHu/hexo-theme-Daily

 _____            _   _
|  __ \          (_) | |
| |  | |   __ _   _  | |  _   _
| |  | |  / _` | | | | | | | | |
| |__| | | (_| | | | | | | |_| |
|_____/   \__,_| |_| |_|  \__, |
                          __/ |
                         |___/

    --------------------------->

</head>


<body>

  <!-- Nav -->
  <header class="site-header">
  <div class="header-inside">
    <div class="logo">
      <a href="/" rel="home">
        
      </a>
    </div>
    <!-- Navigation -->
    <nav class="navbar">
      <!-- Collect the nav links, forms, and other content for toggling -->
      <div class="collapse">
        <ul class="navbar-nav">
          
          
            <li>
              <a href="/.">
                
                  home
                
              </a>
            </li>
          
            <li>
              <a href="/archives">
                
                  archive
                
              </a>
            </li>
          
        </ul>
      </div>
      <!-- /.navbar-collapse -->
    </nav>
    <div class="button-wrap">
      <button class="menu-toggle">Primary Menu</button>
    </div>
  </div>
</header>


  <!-- Main Content -->
  <div class="content-area">
  <div class="post">
    <!-- Post Content -->
    <div class="container">
      <article>
        <!-- Title date & tags -->
        <div class="post-header">
          <h1 class="entry-title">
            Daily Work 2019-08-29
            
          </h1>
          <p class="posted-on">
          2019-08-29
          </p>
          <div class="tags-links">
            
              
                <a href="/tags/Daily Work/" rel="tag">
                  Daily Work
                </a>
              
            
          </div>
        </div>
        <!-- Post Main Content -->
        <div class="entry-content has_line_number">
          <p>Daily Work For 2019-08-29</p>
<a id="more"></a>

<ol>
<li>After review of reportTaskUpdate, modify the suggestions</li>
<li>Refactored getTask, add Common function: getTaskState using concurrency </li>
<li>Added UT for getTask</li>
<li>Landed PushOrderUpdate</li>
<li>Landed GetTask –?</li>
<li>updated Wiki</li>
</ol>
<p>{<br>    “merchantClusterRel”: [<br>        {<br>            “merchantClusterRelID”: “test123456”,<br>            “merchantID”: “6-CYVTRNLVRRAHN2”,<br>            “merchantClusterID”: “wenyue-test”,<br>            “createdAt”: “2019-08-28T08:12:02Z”,<br>            “updatedAt”: “2019-08-28T08:12:02Z”<br>        },<br>        {<br>            “merchantClusterRelID”: “test1234”,<br>            “merchantID”: “IDGFSTI00000d7j”,<br>            “merchantClusterID”: “wenyue-test”,<br>            “createdAt”: “2019-08-28T08:00:30Z”,<br>            “updatedAt”: “2019-08-28T08:00:30Z”<br>        },<br>        {<br>            “merchantClusterRelID”: “test12345”,<br>            “merchantID”: “6-CYNVPCCJE4JUTX”,<br>            “merchantClusterID”: “wenyue-test”,<br>            “createdAt”: “2019-08-28T08:03:04Z”,<br>            “updatedAt”: “2019-08-28T08:03:04Z”<br>        },<br>        {<br>            “merchantClusterRelID”: “test123”,<br>            “merchantID”: “6-CYNZNTBWGFKKLN”,<br>            “merchantClusterID”: “wenyue-test”,<br>            “createdAt”: “2019-08-28T07:59:52Z”,<br>            “updatedAt”: “2019-08-28T07:59:52Z”<br>        }<br>    ]<br>}</p>
<p>2019-09-09</p>
<ol>
<li><p>DONE:add merchantClusterID into snapshot<br>DONE:landed add merchantID into metadata.additionalPreparationTask<br>DONE:rollout onto prd</p>
</li>
<li><p>test manually-accept case<br>fix bug of MA: Find OUT, need discuss.</p>
</li>
<li><p>reportTaskUpdate 的时候会重复调用很多次GetPartnerPreparationTask  food/food-preparation-api/server/handlers/reporttaskupdate.go:62</p>
</li>
<li><p>getAllFPTTasks food/food-preparation-api/server/handlers/reporttaskupdate.go:99</p>
</li>
</ol>
<p>2019-09-10<br>1.Done: read autoHeal code, discuss with lixiang</p>
<ol start="2">
<li>add TotalFPTCount into FPTTask</li>
<li>test </li>
<li>Done: change createTask</li>
<li>Done: learned test branch on staging</li>
<li>chenchen asked questions</li>
</ol>
<p>2019-09-17</p>
<ol>
<li>修改test</li>
<li>修改reportTaskUpdate</li>
<li>删除GKMM</li>
</ol>
<p>2019-10-08</p>
<ol>
<li>加gandalf测试</li>
<li>修改rolloutplan</li>
<li>rollout 5%</li>
<li>修改additionalTask</li>
</ol>
<p>如果是normal订单，taskID = PTID<br>如果是LeadsGen订单， </p>
<p>以前是对于normal订单就直接是外层的， 对于gkmm订单随便选一个</p>
<p>mcd domino, leadsgen怎么办<br>1st level 的partnerPTID还有用吗</p>
<p>5%有问题吗</p>
<p>leadsgen 在哪儿填写的merchantID</p>
<p>2019.10.25</p>
<ol>
<li>add dd, delete qsrCode </li>
<li>自己的partnerPTID.  <a href="https://diff.myteksi.net/D208525" target="_blank" rel="noopener">https://diff.myteksi.net/D208525</a> -&gt; done</li>
<li>review change  -&gt; done</li>
<li>科技爱好者周刊 -&gt; done</li>
<li>填写lifu的PDF  -&gt; done</li>
<li>rollout 0%    -&gt; done</li>
</ol>
<p>2019.10.29</p>
<ol>
<li>add flag in ucm  -&gt; tmr</li>
<li>rollout 1 for partnerPTID -&gt; tmr</li>
<li>observe datadog -&gt; tmr</li>
<li>重构FPI reportTaskUpdate -&gt; WIP</li>
<li>move getDataDog to inner_order.go -&gt; done</li>
</ol>
<p>2019.10.31</p>
<ol>
<li>必须仔细想一下partnerPTID的来龙去脉<br> addPartnerPTID <a href="https://diff.myteksi.net/D209814" target="_blank" rel="noopener">https://diff.myteksi.net/D209814</a></li>
</ol>
<ol start="2">
<li><p>增加flag</p>
</li>
<li><p>增加conflictmap</p>
</li>
<li><p>增加datadog 检测有多少conflict</p>
</li>
<li><p>STUCK： 增加datadog检测cancel了多少stuck的订单<br> 新开了stg的开关</p>
</li>
<li><p>udpate yuhang doc</p>
</li>
</ol>
<ol>
<li><p>不支持AA -&gt; IntegratedAA = 0, 也就是支持MA</p>
</li>
<li><p>不支持MA -&gt; IntegratedAA = 1. 也就是支持AA</p>
</li>
<li><p>比如说，mxiMatch不支持MA， 如果出现了MA，就应该报错</p>
</li>
</ol>
<p>// ConflictCheck …<br>func ConflictCheck(features []uint, cType ConflictType) (bool, string) {<br>    for f, cMap := range conflictMap {<br>        if unitInSlice(f, features) {<br>            for sub, ret := range cMap {<br>                if unitInSlice(sub, features) {<br>                    if ret.cType == NoConflict {<br>                        return false, “”<br>                    }<br>                    if ret.cType == cType {<br>                        return true, ret.errReason<br>                    }<br>                }<br>            }<br>        }<br>    }<br>    return false, “”<br>}</p>
<p>检查feature中同时设置的flags</p>
<p>它是一个什么样的单   ——&gt; 如果不是AA， 那就是MA<br>      vs<br>它是一个支持什么样的单 -&gt; 如果不支持AA，那就是支持MA</p>
<p>在设置flag的时候， 表达的是它是一个什么样的单<br>但是在检查conflict的时候，表达的是它支持什么样的单</p>
<p>那么就有矛盾了， 比如cash来说，我都支持， 但是因为这一单是一个cash的单，所以就设置cash flag</p>
<p>但是对于MA 、AA， 我需要判断这单是不是，而不是支不支持</p>
<p>比如这个merchant是groupB的，所以flag里面既有AA也有MA<br>但是在判断订单的时候</p>
<p>现在LeadsGen的订单是支持MA，不支持AA的。 假如一个LeadsGen商家是GroupB, 那么它的flag就会有AA &amp;&amp; MA。在做conflict检查的时候，即使这个单是MA的，也会因为在ConflictMap中看到AA，会被ban.</p>
<p>原来的逻辑：<br>对于LeadsGen订单， 是只支持MA，不支持AA的。 如果一个LeadsGen的商家被配成了GroupA/GroupB, flag就会有AA，就会引起conflict</p>
<p>如果在一个自动接单的商家，下一个只支持手动接单的单子（比如LeadsGen），</p>
<p>如果在一个手动接单的商家，下一个只支持自动接单的单子， （意思就是我下了，你必须得接单）</p>
<p>商家AA，order类型只支持MA，那么 conflictMap只要有AA Flag， 就报错</p>
<p>商家是MA， order类型只支持AA，</p>
<p>2019.11.1</p>
<ol>
<li>fix hasib typo</li>
<li>add IntegratedMA</li>
<li>add IntegratedMA datadog tag</li>
<li>orderFlag hangzong</li>
<li>delete GKMM unused code</li>
</ol>
<p>todo</p>
<ol>
<li>搞清楚为什么没有stuckOrder？<br>已经搞清楚了， 是ucm的开关的问题</li>
</ol>
<ol start="2">
<li>搞清楚为什么datadog显示不出来<br>搞清楚了，是logtag的问题。<br>prd 打开了。</li>
</ol>
<ol start="3">
<li><p>搞清楚没什么没有partnerPTID<br>等fix上线之后可以打开1%</p>
</li>
<li><p>删除GKMM的ucm</p>
</li>
</ol>
<ol start="5">
<li>转移datadog的图到OM中<br>done</li>
</ol>
<p>2019.11.5</p>
<ol>
<li>问问FDT要不要force-cancel<br> -》 DONE</li>
<li>track一下stuck的order有咩有减少<br> -》 DONE</li>
<li>重构shortnumber<br> -》 wait chunhui</li>
<li>stuck 看看FPT怎么回事<br>-》 todo</li>
<li>研究一下om为什么卡住了<br> -》 todo</li>
</ol>
<p>第二点就是 我们对知道怎么处理的flow 要refactor一下 这样比较清楚到底这些flow是怎么工作的</p>
<p>self-pickup和leads-gen也是有很多switch case在里面 合适的话也可以移动到orderflags里面 让这些switch的逻辑centralise在一个地方 至少比较容易找到</p>
<p>food-preparation-api / food-delivery-api 那边暂时还不知道想怎样 宇航倾向于以orderflags里的qsrCode为key 每个key对于一个rules&amp;conditions的数据结构把其他的纬度 （self-pickup什么的）放在这个数据结构里来指导fpi fdi要干嘛</p>
<p>但是你可以从om cashier先入手 把这些特殊的逻辑控制移进去orderflags里 这样别人只需要看这个包就知道我们为这些特殊情况做了什么</p>
<p>lifu.wu 3:46 PM<br>比如说leads-gen就要发收据 self-pickup就要发收据 之类的</p>
<p>可能没有om的那么多<br>你可以一个一个过 比如说 self-pickup你就要研究下 how does cashier know whether an order is self-pickup ?<br>然后看看他有没有做什么特殊处理</p>
<p>11.6</p>
<ol>
<li><p>如何将ban的conflict 一个一个rollout</p>
</li>
<li><p>添加grab flag             -&gt; 加参数？ 放到前面的位去？</p>
</li>
<li><p>改变cash flag 0 ——&gt; 19</p>
</li>
<li><p>add util file in orderflag -&gt; WIP</p>
</li>
<li><p>填写航总的wiki DONE</p>
</li>
<li><p>调查FPT stuck的原因， 检查stuck的趋势<br> 分析了一些可以cancel的。<br> domino hack的单交给OPS去complete，不用管</p>
</li>
<li><p>增加百分比cancel(wait for FDT to decide)<br> 添加ucm templete</p>
</li>
</ol>
<p>food/food-order-manager/dto/z_dto.go:268</p>
<ol>
<li>orderType已经有了，是否要替换</li>
<li>order.Snapshot.CartWithQuote.Orderflags<br> malaka</li>
<li>对于判断的switch，伴随着其他的判断， 例如state的判断， 不好转移food/food-order-manager/server/handlers/cancelorder.go:107</li>
</ol>
<ol>
<li>Domino Hack<br> 商家接单后不行了</li>
<li>leadsgen<br> 商家接单后不行了， 而且商家所在的城市要支持cancel</li>
<li>takeaway<br> 商家接单后不行了</li>
<li>schedulerOrderForbidden<br> ucm 允许SO cancel<br> 骑手拿到之后，要看grabX是否支持<br> 如果是骑手接单之后，要看是否支持<br> 如果是商家接单之后，要看是否支持</li>
</ol>
<ol start="8">
<li>rollout problem  稳定为主</li>
</ol>
<p>11.8</p>
<ol>
<li>rollout 75%</li>
<li>add script 加完了</li>
<li>FDT说下周一一起商量一下</li>
<li>FPT cancel</li>
<li>add UT for order.go</li>
<li></li>
</ol>
<p>const (<br>    NotCancelable = 0<br>    canCancel = 1<br>    canCancelBeforeMexAccept = 2<br>    canCancelAfterMexAccept = 3<br>    canCancelAfterDaxAccept = 4<br>    canCancelAfterDaxCollect = 5</p>
<p>)<br>func GetCancelablePolicy(ctx context.Context, orderflag int64, order dto.Order) int64 {<br>    if IsSet(orderflag, Concierge) {<br>        return canCancel<br>    }<br>    if IsSet(orderflag, ScheduledOrder) {<br>        if !ucm.GetVariables().EnableSchedulerOrderCancelPolicy {<br>            return NotCancelable<br>        }<br>        if external.GrabX.EnableCancelSOAfterDaxCollect(ctx, order.PaxID, order.CityID){<br>            return canCancelAfterDaxCollect<br>        }<br>        if external.GrabX.EnableCancelSOAfterDaxAccept(ctx, order.PaxID, order.CityID) {<br>            return canCancelAfterDaxAccept<br>        }<br>        if external.GrabX.EnableCancelSOAfterMexAccept(ctx, order.PaxID, order.CityID) {<br>            return canCancelAfterMexAccept<br>        }<br>    }<br>    switch GetOrderFlow(orderflag) {<br>    case SelfPickUp:<br>        return canCancelBeforeMexAccept<br>    case OrderFlowStandardLeadsGen:<br>        countryCode := “”<br>        if order.SnapshotDetail != nil {<br>            countryCode = order.SnapshotDetail.CountryCode<br>        }<br>        if rolloututils.IsStrInStringList(countryCode, ucm.GetVariables().OnlyAllowCancelBeforeMexAcceptCountryForLeadsGen) {<br>            return NotCancelable<br>        }<br>        return canCancelBeforeMexAccept<br>    case OrderFlowDominoHack:<br>        return canCancelBeforeMexAccept<br>    }<br>}</p>

        </div>
      </article>
    </div>
    <!-- Comments -->
    <div class="container">
      
<section id="comment">
  <!-- <h1 class="title">Comments</h1> -->

  
</section>


    </div>
    <!-- Pre or Next -->
    <div class="nav-links">
      
        <div class="nav-previous">
          <a href="/2019/08/29/concurrency/" rel="prev"><span class="meta-arraw meta-arraw-left"></span> Older Posts</a>
        </div>
      
      
        <div class="nav-next">
          <a href="/2019/08/29/Tasks/" rel="prev">Newer Posts <span class="meta-arraw meta-arraw-right"></span></a>
        </div>
      
    </div>

  </div>
</div>


  <!-- Footer -->
  <!-- Footer-widgets -->
<div class="footer-widgets">
  <div class="row inside-wrapper">
    <div class="col-1-3">
      <aside>
        <h1 class="widget-title"></h1>
        <div class="custom-widget-content">
          
          <p></p>
        </div>
      </aside>
    </div>
    <div class="col-1-3">
      <aside>
        <h1 class="widget-title">Contact</h1>
        <div class="widget-text">
          
            
              <a href="https://github.com/maxence1" class="icon icon-github" target="_blank">github</a>
            
              <a href="http://weibo.com/maxencius" class="icon icon-weibo" target="_blank">weibo</a>
            
              <a href="maxence.feng@gmail.com" class="icon icon-mail" target="_blank">mail</a>
            
          
        </div>
      </aside>
    </div>
    <div class="col-1-3">
      <aside>
        <h1 class="widget-title">Search</h1>
        <div class="widget-text">
          <form onSubmit="return appDaily.submitSearch('')">
            <p>
              <input type="text" placeholder="search..." id="homeSearchInput">
            </p>
            <!-- <input type="submit" value="GO"> -->
          </form>
        </div>
      </aside>
    </div>
  </div>
</div>
<!-- Footer -->
<footer class="site-info">
  <p>
    <span>The IT Crowd &copy; 2019</span>
    
      <span class="split">|</span>
      <span>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> with Theme <a href="https://github.com/GallenHu/hexo-theme-Daily" target="_blank">Daily</a></span>
    
  </p>
</footer>


  <!-- After footer scripts -->
  <!-- scripts -->
<script src="/js/app.js"></script>





</body>

</html>
